# Conversation App

A Django app for managing chat data with diagnostic information and medical triage capabilities.

## Features

- **Unified Data Management**: Single endpoint for creating and updating chat data
- **Diagnostic Information**: Store pre-diagnosis, comments, priority scores, and filled documents
- **Chat Content Storage**: Store initial questions and LLM-generated questions separately
- **Auto-generated Identifiers**: Automatic number generation for new chat sessions
- **Priority Scoring**: Track priority levels (Alta, Media, Baja prioridad)
- **RESTful API**: Simple and efficient API design

## Models

### ChatData
- `number`: Unique identifier for the chat session (auto-generated if not provided)
- `initial_questions`: The initial questions from the user
- `llm_questions`: Questions generated by the LLM system
- `pre_diagnosis`: Pre-diagnostic analysis of the user's condition
- `comments`: Comments from sub-agent analysis
- `score`: Priority score (e.g., 'Alta prioridad', 'Media prioridad', 'Baja prioridad')
- `filled_doc`: Complete diagnostic document with detailed analysis
- `created_at`: Timestamp when session was created
- `updated_at`: Timestamp when session was last updated

## API Endpoints

### Unified Chat Data Endpoint

- `POST /conversation/chat/data/` - **Create or Update chat data** (Unified endpoint)
- `GET /conversation/chat/number/<str:number>/` - Get all chat sessions with a specific number

## Usage Examples

### Creating New Chat Data

```python
# Create a new chat session (auto-generates number if not provided)
POST /conversation/chat/data/
{
    "initial_questions": "What are your symptoms? I have a headache and fever.",
    "llm_questions": "How long have you had these symptoms? Any other symptoms?",
    "pre_diagnosis": "Possible viral infection based on symptoms",
    "score": "Media prioridad"
}
```

Response (201 Created):
```json
{
    "id": 1,
    "number": "A1B2C3D4",
    "initial_questions": "What are your symptoms? I have a headache and fever.",
    "llm_questions": "How long have you had these symptoms? Any other symptoms?",
    "pre_diagnosis": "Possible viral infection based on symptoms",
    "comments": null,
    "score": "Media prioridad",
    "filled_doc": null,
    "created_at": "2024-01-15T10:30:00Z",
    "updated_at": "2024-01-15T10:30:00Z"
}
```

### Updating Existing Chat Data

```python
# Update existing chat data by providing the same number
POST /conversation/chat/data/
{
    "number": "A1B2C3D4",
    "comments": "Patient reports improvement after 24 hours",
    "score": "Baja prioridad",
    "filled_doc": "Complete diagnostic report with treatment recommendations"
}
```

Response (200 OK):
```json
{
    "id": 1,
    "number": "A1B2C3D4",
    "initial_questions": "What are your symptoms? I have a headache and fever.",
    "llm_questions": "How long have you had these symptoms? Any other symptoms?",
    "pre_diagnosis": "Possible viral infection based on symptoms",
    "comments": "Patient reports improvement after 24 hours",
    "score": "Baja prioridad",
    "filled_doc": "Complete diagnostic report with treatment recommendations",
    "created_at": "2024-01-15T10:30:00Z",
    "updated_at": "2024-01-15T11:45:00Z"
}
```

### Creating with Specific Number

```python
# Create with a specific number
POST /conversation/chat/data/
{
    "number": "PATIENT_001",
    "initial_questions": "Chest pain and shortness of breath",
    "score": "Alta prioridad"
}
```

### Retrieving Chat Data by Number

```python
# Get all chat sessions with a specific number
GET /conversation/chat/number/A1B2C3D4/
```

Response:
```json
[
    {
        "id": 1,
        "number": "A1B2C3D4",
        "initial_questions": "What are your symptoms? I have a headache and fever.",
        "llm_questions": "How long have you had these symptoms? Any other symptoms?",
        "pre_diagnosis": "Possible viral infection based on symptoms",
        "comments": "Patient reports improvement after 24 hours",
        "score": "Baja prioridad",
        "filled_doc": "Complete diagnostic report with treatment recommendations",
        "created_at": "2024-01-15T10:30:00Z",
        "updated_at": "2024-01-15T11:45:00Z"
    }
]
```

## Endpoint Behavior

### POST /conversation/chat/data/

This unified endpoint handles both creation and updates:

1. **If `number` is provided and exists**: Updates the existing record (partial update)
2. **If `number` is not provided or doesn't exist**: Creates a new record
3. **Auto-generation**: If no `number` is provided, generates a unique 8-character identifier

### Supported Fields

All fields are optional when creating or updating:

- `number`: Unique identifier (auto-generated if not provided)
- `initial_questions`: Text field for initial user questions
- `llm_questions`: Text field for LLM-generated questions  
- `pre_diagnosis`: Text field for pre-diagnostic analysis
- `comments`: Text field for additional comments
- `score`: String field for priority score
- `filled_doc`: Text field for complete diagnostic document

## Priority Scores

The system supports priority scoring with visual indicators in the admin:

- `"Alta prioridad"` - High priority (red)
- `"Media prioridad"` - Medium priority (orange)  
- `"Baja prioridad"` - Low priority (green)

## Authentication

All API endpoints are currently set to `AllowAny` for development. Update the permission classes as needed for your production environment.
